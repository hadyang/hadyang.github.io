<!DOCTYPE html>
<html lang="zh-CN">
<head>

  <meta charset="utf-8" />

  
  <title>View的绘制过程</title>

  
  
  <link href="//cdn.jsdelivr.net" rel="dns-prefetch">
  <link href="//cdnjs.cloudflare.com" rel="dns-prefetch">
  <link href="//at.alicdn.com" rel="dns-prefetch">
  <link href="//fonts.googleapis.com" rel="dns-prefetch">
  <link href="//fonts.gstatic.com" rel="dns-prefetch">
  
  
  
  
  

  

  
  
  <meta name="description" content="上次我们分析了Activity的启动过程，我们已经分析到ActivityThread.main函数，接下来两篇文章我们分析Activity的绘制、时间分发过程。以前，Activity的绘制在我的印象中就measure、lyaout、draw三个过程，对于这三个过程具体的调用过程和细节知之甚少，下面我们就来分析一下Activity的绘制过程。
">

  
  
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@gohugoio">
    <meta name="twitter:title" content="View的绘制过程">
    <meta name="twitter:description" content="上次我们分析了Activity的启动过程，我们已经分析到ActivityThread.main函数，接下来两篇文章我们分析Activity的绘制、时间分发过程。以前，Activity的绘制在我的印象中就measure、lyaout、draw三个过程，对于这三个过程具体的调用过程和细节知之甚少，下面我们就来分析一下Activity的绘制过程。
">
    <meta name="twitter:image" content="/hadyang.github.io/images/avatar.png">
  

  
  <meta property="og:type" content="article">
  <meta property="og:title" content="View的绘制过程">
  <meta property="og:description" content="上次我们分析了Activity的启动过程，我们已经分析到ActivityThread.main函数，接下来两篇文章我们分析Activity的绘制、时间分发过程。以前，Activity的绘制在我的印象中就measure、lyaout、draw三个过程，对于这三个过程具体的调用过程和细节知之甚少，下面我们就来分析一下Activity的绘制过程。
">
  <meta property="og:url" content="hadyang.github.io/2016/06/android-view-draw/">
  <meta property="og:image" content="/hadyang.github.io/images/avatar.png">




<meta name="generator" content="Hugo 0.54.0">


<link rel="canonical" href="hadyang.github.io/2016/06/android-view-draw/">

<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="format-detection" content="telephone=no,email=no,adress=no">
<meta http-equiv="Cache-Control" content="no-transform">


<meta name="robots" content="index,follow">
<meta name="referrer" content="origin-when-cross-origin">







<meta name="theme-color" content="#02b875">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="HadYang">
<meta name="msapplication-tooltip" content="HadYang">
<meta name='msapplication-navbutton-color' content="#02b875">
<meta name="msapplication-TileColor" content="#02b875">
<meta name="msapplication-TileImage" content="/hadyang.github.io/icons/icon-144x144.png">
<link rel="icon" href="/hadyang.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/hadyang.github.io/icons/icon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/hadyang.github.io/icons/icon-32x32.png">
<link rel="icon" sizes="192x192" href="/hadyang.github.io/icons/icon-192x192.png">
<link rel="apple-touch-icon" href="/hadyang.github.io/icons/icon-152x152.png">
<link rel="manifest" href="/hadyang.github.io/manifest.json">


<link rel="preload" href="/hadyang.github.io/styles/main.min.css" as="style">

<link rel="preload" href="https://fonts.googleapis.com/css?family=Lobster" as="style">
<link rel="preload" href="/hadyang.github.io/images/avatar.png" as="image">
<link rel="preload" href="/hadyang.github.io/images/grey-prism.svg" as="image">


<style>
  body {
    background: rgb(244, 243, 241) url('/hadyang.github.io/images/grey-prism.svg') repeat fixed;
  }
</style>
<link rel="stylesheet" href="/hadyang.github.io/styles/main.min.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">



<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.2/dist/medium-zoom.min.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css">



  
  
<!--[if lte IE 8]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js"></script>
<![endif]-->

<!--[if lte IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js"></script>
<![endif]-->


</head>
  <body>
    
    <div class="suspension">
      <a role="button" aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class="icon icon-up" aria-hidden="true"></span></a>
      
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="/hadyang.github.io/images/avatar.png" alt="Avatar">
  
  <h2 class="title">HadYang</h2>
  
  <p class="subtitle"></p>
  <button class="menu-toggle" type="button" aria-label="Main Menu" aria-expanded="false" tab-index="0">
    <span class="icon icon-menu" aria-hidden="true"></span>
  </button>

  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
          
          
           is-active">
          <a href="hadyang.github.io/">Home</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="hadyang.github.io/tags/">Tags</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="hadyang.github.io/categories/">Categories</a>
        </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list"><li class="social-item">
          <a href="mailto:shihaoyang129@gmail.com" title="Email" aria-label="Email">
            <span class="icon icon-email" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="//github.com/hadyang" title="GitHub" aria-label="GitHub">
            <span class="icon icon-github" aria-hidden="true"></span>
          </a>
        </li></ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">View的绘制过程</h1>
      <p class="post-meta">@ · Jun 1, 2016 · 5 min read</p>
    </header>
    <article class="post-content"><p>上次我们分析了Activity的启动过程，我们已经分析到ActivityThread.main函数，接下来两篇文章我们分析Activity的绘制、时间分发过程。以前，Activity的绘制在我的印象中就measure、lyaout、draw三个过程，对于这三个过程具体的调用过程和细节知之甚少，下面我们就来分析一下Activity的绘制过程。</p>

<ul>
<li>Step1 &ndash; ActivityThread.main()</li>
</ul>

<pre><code class="language-Java">//android.app.ActivityThread.java
 public static final void main(String[] args) {
        ...
        //初始化主线程消息循环
        Looper.prepareMainLooper();

        //由于ApplicationThread是ActivityThread的成员变量，所以同时也new ApplicationThread
        ActivityThread thread = new ActivityThread();

        //step2
        thread.attach(false);

        Looper.loop();

        ...
        thread.detach();
        ...
    }
}
</code></pre>

<ul>
<li>Step2 &ndash; attach(false)</li>
</ul>

<pre><code class="language-Java">//android.app.ActivityThread.java
private final void attach(boolean system) {
        sThreadLocal.set(this);
        mSystemThread = system;
        //非系统应用
        if (!system) {
            ViewRoot.addFirstDrawHandler(new Runnable() {
                public void run() {
                    ensureJitEnabled();//确保开启JNI
                }
            });
           ...
            RuntimeInit.setApplicationObject(mAppThread.asBinder());
            IActivityManager mgr = ActivityManagerNative.getDefault();//获取ActivityManagerService的Binder代理
            try {
                //Step3
                mgr.attachApplication(mAppThread);
            } catch (RemoteException ex) {
            }
        }
        //系统应用
        ...

        //添加OnLowMemory等事件回调
        ViewRoot.addConfigCallback(...);
</code></pre>

<ul>
<li>Step3 &ndash; attachApplication(mAppThread)</li>
</ul>

<pre><code class="language-Java">//com.android.server.am.ActivityManagerService.java
public final void attachApplication(IApplicationThread thread) {
        synchronized (this) {
            int callingPid = Binder.getCallingPid();//获取调用进程PID
            final long origId = Binder.clearCallingIdentity();
            //Step4
            attachApplicationLocked(thread, callingPid);
            Binder.restoreCallingIdentity(origId);
        }
    }
</code></pre>

<ul>
<li>Step4 &ndash; attachApplicationLocked()</li>
</ul>

<pre><code class="language-Java">//com.android.server.am.ActivityManagerService.java
private final boolean attachApplicationLocked(IApplicationThread thread,int pid) {

        // Find the application record that is being attached...  either via
        // the pid if we are running in multiple processes, or just pull the
        // next app record if we are emulating process with anonymous threads.
        ProcessRecord app;
        if (pid != MY_PID &amp;&amp; pid &gt;= 0) {
            synchronized (mPidsSelfLocked) {
                app = mPidsSelfLocked.get(pid);
            }

        ...
        // 初始化ProcessRecord，这个变量是存储在AMS中的
        app.thread = thread;
        app.curAdj = app.setAdj = -100;
        app.curSchedGroup = Process.THREAD_GROUP_DEFAULT;
        app.setSchedGroup = Process.THREAD_GROUP_BG_NONINTERACTIVE;
        app.forcingToForeground = null;
        app.foregroundServices = false;
        app.debugging = false;

        ...
          //命令客户进程运行指定的Activity所在的APK文件，这个函数最终会调用ActivityThread.handleBindApplication
          //Step5
          thread.bindApplication(...)
        ...

        //Step6
        if (realStartActivityLocked(hr, app, true, true)) {
                        didSomething = true;
         }

        // Find any services that should be running in this process...
        ...

        // Check if the next broadcast receiver is in this process...
        ...

        // Check whether the next backup agent is in this process...
        ...
</code></pre>

<ul>
<li>Step5 &ndash; handleBindApplication(AppBindData)</li>
</ul>

<pre><code class="language-Java">//android.os.ActivityThread.java
private final void handleBindApplication(AppBindData data) {
        ...

        // 新建Application，Step5.1
        Application app = data.info.makeApplication(data.restrictedBackupMode, null);
        mInitialApplication = app;
</code></pre>

<ul>
<li>Step5.1 &ndash; makeApplication(boolean forceDefaultAppClass,Instrumentation instrumentation)</li>
</ul>

<pre><code class="language-Java">//android.os.ActivityThread.java
public Application makeApplication(boolean forceDefaultAppClass, Instrumentation instrumentation) {
            if (mApplication != null) {
                return mApplication;
            }

            Application app = null;

            String appClass = mApplicationInfo.className;

            try {
                java.lang.ClassLoader cl = getClassLoader();
                ContextImpl appContext = new ContextImpl();
                appContext.init(this, null, mActivityThread);
                //创建Application对象，并将appContext attach到Application对象上
                app = mActivityThread.mInstrumentation.newApplication(cl, appClass, appContext);
                appContext.setOuterContext(app);
            }
            mActivityThread.mAllApplications.add(app);
            mApplication = app;

            return app;
        }

</code></pre>

<ul>
<li>Step6 &ndash; realStartActivityLocked()</li>
</ul>

<pre><code class="language-Java">//com.android.server.am.ActivityManagerService.java
private final boolean realStartActivityLocked(HistoryRecord r,ProcessRecord app, boolean andResume, boolean checkConfig)
            throws RemoteException {
        ...
        r.app = app;
        ...
        //Step7
        app.thread.scheduleLaunchActivity(new Intent(r.intent), r,
                    System.identityHashCode(r),
                    r.info, r.icicle, results, newIntents, !andResume,
                    isNextTransitionForward());
        ...
</code></pre>

<ul>
<li>Step7 &ndash; scheduleLaunchActivity</li>
</ul>

<p>通过消息循环最终会调用handleLaunchActivity</p>

<pre><code class="language-Java">//android.os.ActivityThread.java
private final void handleLaunchActivity(ActivityRecord r, Intent customIntent) {
        ...
        //Step8
        Activity a = performLaunchActivity(r, customIntent);
        ...

        if (a != null) {
            r.createdConfig = new Configuration(mConfiguration);
            Bundle oldState = r.state;
            //Step9
            handleResumeActivity(r.token, false, r.isForward);
         }
        ...
}
</code></pre>

<ul>
<li>Step8 &ndash; performLaunchActivity</li>
</ul>

<pre><code class="language-Java">private final Activity performLaunchActivity(ActivityRecord r, Intent customIntent) {
        ActivityInfo aInfo = r.activityInfo;
        ...
        //设置启动Activity信息
        ComponentName component = r.intent.getComponent();
        if (component == null) {
            component = r.intent.resolveActivity(
                mInitialApplication.getPackageManager());
            r.intent.setComponent(component);
        }

        if (r.activityInfo.targetActivity != null) {
            component = new ComponentName(r.activityInfo.packageName,
                    r.activityInfo.targetActivity);
        }

        Activity activity = null;
       ...
        //通过反射生成Activity
        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();
        activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);
        r.intent.setExtrasClassLoader(cl);
        ...

         Application app = r.packageInfo.makeApplication(false, mInstrumentation);

            if (activity != null) {
                ContextImpl appContext = new ContextImpl();
                appContext.init(r.packageInfo, r.token, this);
                appContext.setOuterContext(activity);
                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());
                Configuration config = new Configuration(mConfiguration);

                //Step8.1
                activity.attach(appContext, this, getInstrumentation(), r.token,
                        r.ident, app, r.intent, r.activityInfo, title, r.parent,
                        r.embeddedID, r.lastNonConfigurationInstance,
                        r.lastNonConfigurationChildInstances, config);

               //调用Activity.OnCreate函数
                mInstrumentation.callActivityOnCreate(activity, r.state);

                if (!r.activity.mFinished) {
                    //调用Activity.OnStart函数
                    activity.performStart();
                    r.stopped = false;
                }
        return activity;
    }
</code></pre>

<ul>
<li>Step8.1 &ndash; attach</li>
</ul>

<pre><code class="language-Java">//android.app.Activity.java
final void attach(Context context, ActivityThread aThread,
            Instrumentation instr, IBinder token, int ident,
            Application application, Intent intent, ActivityInfo info,
            CharSequence title, Activity parent, String id,
            Object lastNonConfigurationInstance,
            HashMap&lt;String,Object&gt; lastNonConfigurationChildInstances,
            Configuration config) {

        //将Context attach到activity
        attachBaseContext(context);

        //新建PhoneWindow对象
        mWindow = new PhoneWindow(this);
        mWindow.setCallback(this);
        mWindow.setOnWindowDismissedCallback(this);
        mWindow.getLayoutInflater().setPrivateFactory(this);

       ...       
       //设置UI线程
       mUiThread = Thread.currentThread();

        //设置Activity相关属性
        mMainThread = aThread;
        mInstrumentation = instr;
        mToken = token;
        mIdent = ident;
        mApplication = application;
        mIntent = intent;
        mComponent = intent.getComponent();
        mActivityInfo = info;
        mTitle = title;
        mParent = parent;
        mEmbeddedID = id;
        mLastNonConfigurationInstance = lastNonConfigurationInstance;
        mLastNonConfigurationChildInstances = lastNonConfigurationChildInstances;

       ...    
}

</code></pre>

<ul>
<li>Step9 &ndash; handleResumeActivity</li>
</ul>

<pre><code class="language-Java">//android.os.ActivityThread.java
final void handleResumeActivity(IBinder token, boolean clearHide, boolean isForward) {

        //这里会调用performRestart，通过状态来判断是否回调Activity.OnRestart()
        ActivityRecord r = performResumeActivity(token, clearHide);

        if (r != null) {
            final Activity a = r.activity;
            ...

            if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) {
                r.window = r.activity.getWindow();
                View decor = r.window.getDecorView();
                decor.setVisibility(View.INVISIBLE);
                ViewManager wm = a.getWindowManager();
                WindowManager.LayoutParams l = r.window.getAttributes();
                a.mDecor = decor;
                l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;
                l.softInputMode |= forwardBit;
                if (a.mVisibleFromClient) {
                    a.mWindowAdded = true;

                    //Step10
                    wm.addView(decor, l);
                }
                ...
    }
</code></pre>

<ul>
<li>Step10 &ndash; WindowManagerGlobal.addView</li>
</ul>

<p>WindowManagerImpl.addView最终调用WindowManagerGlobal.addView</p>

<pre><code class="language-Java">//android.view.WindowManagerGlobal.java
public void addView(View view, ViewGroup.LayoutParams params,
            Display display, Window parentWindow) {
        ...

        ViewRootImpl root;

        获取ViewRootImpl
        ...

         root = new ViewRootImpl(view.getContext(), display);
          view.setLayoutParams(wparams);
          mViews.add(view);
          mRoots.add(root);
          mParams.add(wparams);

        // do this last because it fires off messages to start doing things
         root.setView(view, wparams, panelParentView);

    }
</code></pre>

<ul>
<li>Step11 &ndash; ViewRootImpl .setView</li>
</ul>

<pre><code class="language-Java">//android.view.ViewRootImpl .java
public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) {

            ...
           // Schedule the first layout -before- adding to the window
           // manager, to make sure we do the relayout before receiving
           // any other events from the system.
           //Step12
            requestLayout();
            ...
    }

</code></pre>

<ul>
<li>Step12 &ndash; requestLayout</li>
</ul>

<pre><code class="language-Java">//android.view.ViewRootImpl .java
public void requestLayout() {
        if (!mHandlingLayoutInLayoutRequest) {
            //检查当前线程是否是UI线程
            checkThread();
            mLayoutRequested = true;
            //Step 13
            scheduleTraversals();
        }
    }
</code></pre>

<ul>
<li>Step13 &ndash; ViewRootImpl.scheduleTraversals</li>
</ul>

<pre><code class="language-Java">void scheduleTraversals() {
        if (!mTraversalScheduled) {
            ...

            //这里通过Runable调用ViewRootImpl.doTraversal Step14
            mChoreographer.postCallback(
                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);
           ...    
}
</code></pre>

<ul>
<li>Step14 &ndash; ViewRootImpl.doTraversal</li>
</ul>

<pre><code class="language-Java">void doTraversal() {
        if (mTraversalScheduled) {
            //Step15
            performTraversals();
    }
</code></pre>

<ul>
<li>Step15 &ndash; ViewRootImpl.performTraversals</li>
</ul>

<pre><code class="language-Java">private void performTraversals() {
        ...
         // Ask host how big it wants to be
         //开始measure过程
         windowSizeMayChange |= measureHierarchy(host, lp, res,desiredWindowWidth, desiredWindowHeight);

        ...   

        if (didLayout) {
            //开始Layout过程
            performLayout(lp, desiredWindowWidth, desiredWindowHeight);
         }
          ...
        //开始Draw过程
        //Step16
         performDraw();
         ...
    }
</code></pre>

<ul>
<li>Step16 &ndash; ViewRootImpl.drawSoftware</li>
</ul>

<p>performDraw会调用ViewRootImpl.draw然后会调用ViewRootImpl.drawSoftware。</p>

<pre><code class="language-Java">private boolean drawSoftware(Surface surface, AttachInfo attachInfo, int xoff, int yoff,
            boolean scalingRequired, Rect dirty) {

        // Draw with software renderer.
        ...

        final Canvas canvas;
        try {
                canvas.translate(-xoff, -yoff);
                if (mTranslator != null) {
                    mTranslator.translateCanvas(canvas);
                }
                canvas.setScreenDensity(scalingRequired ? mNoncompatDensity : 0);
                attachInfo.mSetIgnoreDirtyState = false;
               //进入Draw过程
                mView.draw(canvas);

                drawAccessibilityFocusedDrawableIfNeeded(canvas);
            } finally {
                if (!attachInfo.mSetIgnoreDirtyState) {
                    // Only clear the flag if it was not set during the mView.draw() call
                    attachInfo.mIgnoreDirtyState = false;
                }
            }
         ....
        return true;
    }
</code></pre></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="/tags/%E6%BA%90%E7%A0%81"><span class="tag">源码</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        This post was published <strong>1012</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      
    
  </section>
  
<footer class="site-footer">
  <p>© 2017-2019 HadYang</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank" rel="noopener">Nuo</a>.</p>
  
</footer>


<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@15.0.0/dist/smooth-scroll.min.js"></script>



<script async src="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js"></script>




<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>



<script src="/hadyang.github.io/scripts/index.min.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('\/hadyang.github.io\/service-worker.js').then(function() {
      console.log('[ServiceWorker] Registered');
    });
  }
</script>








  </body>
</html>
